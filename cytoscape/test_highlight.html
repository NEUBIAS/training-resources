<!DOCTYPE html>
<html>
<head>
    <title>Cytoscape Graph for Carpentries Lesson</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
    <script src="https://cytoscape.org/cytoscape.js-klay/cytoscape-klay.js"></script>
    <style>
        body {
            font-family: helvetica;
            font-size: 14px;
        }
        #cy {
            width: 100%;
            height: 500px;
            display: block;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            margin-bottom: 20px;
        }
        .highlighted {
            background-color: #90EE90 !important;
            border-color: #228B22 !important;
            border-width: 3px !important;
            color: #000000 !important;
        }
        .highlighted-edge {
            line-color: #90EE90 !important;
            width: 3px !important;
            color: #000000 !important;
        }
        #navigation-bar {
            background-color: #004d40;
            color: white;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #navigation-bar ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            display: flex;
        }
        #navigation-bar ul li {
            margin-right: 20px;
        }
        #navigation-bar ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }
        #navigation-bar .title {
            font-size: 20px;
            font-weight: bold;
        }
        #controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        #reset-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #reset-button:hover {
            background-color: #45a049;
        }
        #preview-container {
            position: absolute;
            top: 600px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-height: 300px;
            border: 1px solid #ccc;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: auto;
            display: none; /* Initially hidden */
            z-index: 1000;
            padding: 10px;
        }
        #preview-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5px;
        }
        #back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001; /* Ensure it's above the Cytoscape container */
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            display: none; /* Initially hidden */
        }
        #back-button:hover {
            background-color: #45a049;
        }

    </style>
</head>
<body>
    <nav id="navigation-bar">
        <div class="title">Lesson Title</div>
        <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Setup</a></li>
            <li><a href="#">Episodes</a></li>
            <li><a href="#">Reference</a></li>
        </ul>
    </nav>

    <div id="cy"></div>
    <div id="controls">
        <button id="reset-button">Reset Graph</button>
    </div>
    <div id="preview-container">
        <iframe id="preview-frame"></iframe>
    </div>
    <button id="back-button">Back to Graph</button>

    <script>
        // Function to render the graph
        async function renderGraph() {
            try {
                // Mock data for testing
                const mockData = {
                    elements: [
                        { data: { id: 'a', label: 'Node A', url: '../pixels' } },
                        { data: { id: 'b', label: 'Node B', url: '/lesson/module2' } },
                        { data: { id: 'c', label: 'Node C', url: '/lesson/module3' } },
                        { data: { id: 'd', label: 'Node D', url: '/lesson/module4' } },
                        { data: { id: 'e', label: 'Node E', url: '/lesson/module5' } },
                        { data: { id: 'f', label: 'Node F', url: '/lesson/module6' } },
                        { data: { source: 'a', target: 'b', label: '' } },
                        { data: { source: 'b', target: 'c', label: '' } },
                        { data: { source: 'c', target: 'd', label: '' } },
                        { data: { source: 'a', target: 'e', label: '' } },
                        { data: { source: 'e', target: 'f', label: '' } },
                    ],
                    layout: {
                        name: 'klay',
                        klay: {
                            direction: 'DOWN',
                            spacing: 20,
                            edgeSpacingFactor: 0.5,
                            nodeLayering: 'NETWORK_SIMPLEX',
                            edgeRouting: 'ORTHOGONAL',
                            crossingMinimization: 'LAYER_SWEEP',
                            nodePlacement: 'BRANDES_KOEPF'
                        }
                    },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'shape': 'rectangle',
                                'background-color': '#FFFFFF',
                                'border-color': '#228B22',
                                'border-width': 2,
                                'font-size': '14px',
                                'color': '#006400',
                                'padding': '10px',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'width': 80,
                                'height': 30,
                                'text-max-width': 100,
                                'white-space': 'pre-wrap',
                                'overflow': 'hidden',
                                'text-wrap': 'wrap'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#388e3c',
                                'curve-style': 'bezier',
                                'font-size': '10px',
                                'text-rotation': 'autorotate',
                                'text-background-color': '#FFFFFF',
                                'text-background-opacity': 0.7,
                                'display': 'element'
                            }
                        }
                    ]
                };

                // Initialize Cytoscape
                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: mockData.elements,
                    layout: mockData.layout,
                    style: mockData.style
                });

                // Store the initial zoom and pan position
                const initialZoom = cy.zoom();
                const initialPan = cy.pan();

                // Function to reset the graph to its initial zoom and position
                function resetGraph() {
                    cy.zoom(initialZoom);
                    cy.pan(initialPan);
                }

                // Attach the reset function to the button click event
                document.getElementById('reset-button').addEventListener('click', resetGraph);


                // Function to get prerequisites of a node.
                function getPrerequisites(nodeId, graph) {
                    const prereqNodes = new Set();
                    const prereqEdges = new Set();

                    function findPrereqs(node) {
                        prereqNodes.add(node.id());
                        const incomers = graph.collection('edge[target = "' + node.id() + '"]');
                        incomers.forEach(edge => {
                            prereqEdges.add(edge.id());
                            const sourceNode = edge.source();
                            if (sourceNode && !prereqNodes.has(sourceNode.id())) {
                                findPrereqs(sourceNode);
                            }
                        });
                    }

                    const startNode = graph.getElementById(nodeId);
                    if (startNode) {
                        findPrereqs(startNode);
                    }
                    return { nodes: prereqNodeIds, edges: prereqEdgeIds };
                }

                // Get the preview container and iframe
                const previewContainer = document.getElementById('preview-container');
                const previewFrame = document.getElementById('preview-frame');
                const backButton = document.getElementById('back-button');


                // Event listener for node tap (single click)
                cy.on('tap', 'node', function (evt) {
                    const clickedNode = evt.target;
                    const nodeId = clickedNode.id();
                    const url = clickedNode.data('url');

                    // Log the event
                    console.log("Single tap event:", evt);

                    // Check if the shift key is pressed
                    if (evt.originalEvent.shiftKey) {
                        console.log("Shift key:", evt);
                        if (url) {
                            // Open the URL in the same window
                            window.open(url, '_self').focus();
                            // Show the back button
                            backButton.style.display = 'block';
                        }
                    } else {
                        const { nodes: prereqNodeIds, edges: prereqEdgeIds } = getPrerequisites(nodeId, cy);

                        // Reset previous highlighting
                        cy.elements().removeClass('highlighted');
                        cy.elements().removeClass('highlighted-edge');

                        // Reset all node colors to default
                        cy.nodes().style('background-color', '#FFFFFF');

                        // Highlight nodes
                        if (prereqNodeIds) {
                            prereqNodeIds.forEach(nodeId => {
                                const node = cy.getElementById(nodeId);
                                if (node) {
                                    node.addClass('highlighted');
                                    node.style('background-color', '#90EE90');
                                }
                            });
                        }
                        // Highlight edges
                        if (prereqEdgeIds) {
                            prereqEdgeIds.forEach(edgeId => {
                                const edge = cy.getElementById(edgeId);
                                if (edge) {
                                    edge.addClass('highlighted-edge');
                                }
                            });
                        }
                    }
                });

                // Event listener for background tap to hide the preview
                cy.on('tap', function(event){
                    if (event.target === cy){
                        if(previewContainer){ //check if it exists.
                           previewContainer.style.display = 'none';
                           previewFrame.src = '';
                           backButton.style.display = 'none'; // Hide back button

                        }
                    }
                });

                // Event listener for tap on the preview container to prevent propagation
                if(previewContainer){
                    previewContainer.addEventListener('click', function(event) {
                        event.stopPropagation(); // Prevent click from propagating to cy
                    });
                }

                // Event listener for back button
                backButton.addEventListener('click', function() {
                    // Go back in history
                    window.history.back();
                    // keep back button.
                    backButton.style.display = 'block';
                });


            } catch (error) {
                console.error('Error rendering graph:', error);
            }
        }

        // Call the function to render the graph when the page loads
        renderGraph();
    </script>
</body>
</html>
